"use strict";(self.webpackChunkctrader_openapi_docs=self.webpackChunkctrader_openapi_docs||[]).push([[180],{2272:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>p,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"contacting-api/protobuf/compilation-of-proto-files","title":"Compilation of .proto Files","description":"Now that we have installed the compiler and runtime, we can start compiling the","source":"@site/docs/02-contacting-api/07-protobuf/02-compilation-of-proto-files.mdx","sourceDirName":"02-contacting-api/07-protobuf","slug":"/contacting-api/protobuf/compilation-of-proto-files","permalink":"/ctoa/contacting-api/protobuf/compilation-of-proto-files","draft":false,"unlisted":false,"editUrl":"https://github.com/m-ahmadi/ctoa/blob/main/docs/02-contacting-api/07-protobuf/02-compilation-of-proto-files.mdx","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{},"sidebar":"sidebar","previous":{"title":"Compiler and Runtime","permalink":"/ctoa/contacting-api/protobuf/compiler-and-runtime"},"next":{"title":"Contacting API with Protobuf","permalink":"/ctoa/contacting-api/protobuf/contacting-api-with-protobuf"}}');var i=t(4848),a=t(8453),s=t(5537),r=t(9329);const l={},p="Compilation of .proto Files",c={},d=[{value:"Getting <code>.proto</code> Files",id:"getting-proto-files",level:2},{value:"Compile <code>.proto</code> Files",id:"compile-proto-files",level:2},{value:"Main Compiler",id:"main-compiler",level:3},{value:"JavaScript-Specific Compiler",id:"javascript-specific-compiler",level:3},{value:"Using Pre-Compiled Protobuf Messages in Official Python Package",id:"using-pre-compiled-protobuf-messages-in-official-python-package",level:2},{value:"Convert to JSON",id:"convert-to-json",level:3},{value:"Correct Name of PyPi Package",id:"correct-name-of-pypi-package",level:3}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsxs)(n.h1,{id:"compilation-of-proto-files",children:["Compilation of ",(0,i.jsx)(n.code,{children:".proto"})," Files"]})}),"\n",(0,i.jsxs)(n.p,{children:["Now that we have installed the compiler and runtime, we can start compiling the\n",(0,i.jsx)(n.code,{children:".proto"})," files. So where are these ",(0,i.jsx)(n.code,{children:".proto"})," files anyway?"]}),"\n",(0,i.jsxs)(n.h2,{id:"getting-proto-files",children:["Getting ",(0,i.jsx)(n.code,{children:".proto"})," Files"]}),"\n",(0,i.jsxs)(n.p,{children:["The cTrader OpenAPI publishes its ",(0,i.jsx)(n.code,{children:".proto"})," files in the following GitHub\nrepository:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://github.com/spotware/openapi-proto-messages",children:"https://github.com/spotware/openapi-proto-messages"})}),"\n",(0,i.jsx)(n.p,{children:"Let's get a copy of them:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"git clone https://github.com/spotware/openapi-proto-messages\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["if you don't have ",(0,i.jsx)(n.a,{href:"https://git-scm.com/downloads",children:(0,i.jsx)(n.code,{children:"git"})})," installed on your\nsystem, you can download them manually by going into the page and click the\n",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"<> Code"})})," button, and then the ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"Download ZIP"})})," button."]})}),"\n",(0,i.jsxs)(n.p,{children:["Now that we have the ",(0,i.jsx)(n.code,{children:".proto"})," files in a directory named\n",(0,i.jsx)(n.code,{children:"openapi-proto-messages"}),", it's time to compile them."]}),"\n",(0,i.jsxs)(n.h2,{id:"compile-proto-files",children:["Compile ",(0,i.jsx)(n.code,{children:".proto"})," Files"]}),"\n",(0,i.jsx)(n.h3,{id:"main-compiler",children:"Main Compiler"}),"\n",(0,i.jsxs)(s.A,{children:[(0,i.jsx)(r.A,{value:"Windows",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"protoc --proto_path=openapi-proto-messages --python_out=./ ^\n  OpenApiMessages.proto ^\n  OpenApiModelMessages.proto ^\n  OpenApiCommonMessages.proto ^\n  OpenApiCommonModelMessages.proto\n"})})}),(0,i.jsx)(r.A,{value:"Linux",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"protoc --proto_path=openapi-proto-messages --python_out=./ \\\n  OpenApiMessages.proto \\\n  OpenApiModelMessages.proto \\\n  OpenApiCommonMessages.proto \\\n  OpenApiCommonModelMessages.proto\n"})})})]}),"\n",(0,i.jsx)(n.p,{children:"Now we have the below compiled files:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"OpenApiMessages_pb2.py\nOpenApiModelMessages_pb2.py\nOpenApiCommonMessages_pb2.py\nOpenApiCommonModelMessages_pb2.py\n"})}),"\n",(0,i.jsx)(n.p,{children:"Which we will import in our Python code like below:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-py",children:"import OpenApiMessages_pb2.py as OA\nimport OpenApiModelMessages_pb2.py as OAModel\nimport OpenApiCommonMessages_pb2.py as OACommon\nimport OpenApiCommonModelMessages_pb2.py as OACommonModel\n"})}),"\n",(0,i.jsx)(n.h3,{id:"javascript-specific-compiler",children:"JavaScript-Specific Compiler"}),"\n",(0,i.jsxs)(s.A,{children:[(0,i.jsx)(r.A,{value:"Windows",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"cd openapi-proto-messages\n\npbjs -t json-module -o ../pb.compiled.js --no-beautify --no-comments ^\n  OpenApiMessages.proto ^\n  OpenApiModelMessages.proto ^\n  OpenApiCommonMessages.proto ^\n  OpenApiCommonModelMessages.proto\n"})})}),(0,i.jsx)(r.A,{value:"Linux",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"cd openapi-proto-messages\n\npbjs -t json-module -o ../pb.compiled.js --no-beautify --no-comments \\\n  OpenApiMessages.proto \\\n  OpenApiModelMessages.proto \\\n  OpenApiCommonMessages.proto \\\n  OpenApiCommonModelMessages.proto\n"})})})]}),"\n",(0,i.jsx)(n.p,{children:"In the case of JavaScript, we will have one single file as the output of\ncompilation:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"pb.compiled.js\n"})}),"\n",(0,i.jsx)(n.p,{children:"Which we will import in our Node.js code like below:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"var pb = require('./pb.compiled.js');\n"})}),"\n",(0,i.jsx)(n.h2,{id:"using-pre-compiled-protobuf-messages-in-official-python-package",children:"Using Pre-Compiled Protobuf Messages in Official Python Package"}),"\n",(0,i.jsxs)(n.p,{children:["There is another way to use the compiled ",(0,i.jsx)(n.code,{children:".proto"})," files without actually\ncompliing them ourselves, and that is through using the\n",(0,i.jsx)(n.a,{href:"https://pypi.org/project/ctrader_open_api/",children:"cTrader OpenAPI Official Python Package"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["There is also another way to get to use already compiled ",(0,i.jsx)(n.code,{children:".proto"})," files which\nexist in the\n",(0,i.jsx)(n.a,{href:"https://pypi.org/project/ctrader_open_api/",children:"official Python package"}),". Since\nthis way we can skip the compilation step, it's worth mentioning. Keep in mind\nwe still need the runtime in this approach, but we only skip that step because\nwhen we install the official Python package, the runtime is installed with it\n(because the runtime is a dependency of it)."]}),"\n",(0,i.jsx)(n.p,{children:"So let's create a python virtual environment for an isolated environment and\nactivate it:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"python -m venv .env\n./env/Scripts/activate\n"})}),"\n",(0,i.jsx)(n.p,{children:"Now let's see what packages we have at this point:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"pip list\n# Package    Version\n# ---------- -------\n# pip        21.2.3\n# setuptools 57.4.0\n"})}),"\n",(0,i.jsx)(n.p,{children:"Now we will intsall the offical cTrader Python package, and after it's done, we\nwill check again to see what packages were installed:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"pip install ctrader_open_api\npip list\n"})}),"\n",(0,i.jsx)(n.p,{children:"Which will output a (somewhat) long list of packages that were just installed:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Package             Version\n------------------- --------\n...\n...\nprotobuf            3.20.1\n...\n...\n"})}),"\n",(0,i.jsx)(n.p,{children:"And there it is, that is the runtime being installed when you install the\nofficial Python package, and you can see that its version is much older that the\nruntime we installed ourself."}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["When you have an older runtime like here, it can't load ",(0,i.jsx)(n.code,{children:".proto"})," files compiled\nwith a new compiler. Yes, we're not complining anything here, and that was the\nwhole point of this section, but hypothetically, if we did, it would be an\nexample of Cross-Version runtime that was\n",(0,i.jsx)(n.a,{href:"./compiler-and-runtime#compiler-and-runtime-versions",children:"mentioned earlier"}),"."]})}),"\n",(0,i.jsxs)(n.p,{children:["After we install the official package, we can access the already compiled\n",(0,i.jsx)(n.code,{children:".proto"})," files like below:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-py",children:"import ctrader_open_api.messages.OpenApiMessages_pb2 as OA\nimport ctrader_open_api.messages.OpenApiModelMessages_pb2 as OAModel\nimport ctrader_open_api.messages.OpenApiCommonMessages_pb2 as OACommon\nimport ctrader_open_api.messages.OpenApiCommonModelMessages_pb2 as OAModelCommon\n"})}),"\n",(0,i.jsx)(n.h3,{id:"convert-to-json",children:"Convert to JSON"}),"\n",(0,i.jsxs)(n.p,{children:["As you might have guessed, this approach of using official Python package to\nskip the compilation step can be considered a solution if you're using Python,\nbut what about another programming language? In that case, we can extract the\ninformation in ",(0,i.jsx)(n.code,{children:".proto"})," files and export it into a ",(0,i.jsx)(n.code,{children:"JSON"})," format. Altough not an\nelegant solution, but still has some value due to it being easy and not needing\nthe compilation step. (For example in a case where you just want to test\nsomething)."]}),"\n",(0,i.jsx)(n.p,{children:"Below is an example of doing so:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-py",children:"import ctrader_open_api.messages.OpenApiModelMessages_pb2 as OAModel\nimport json\n\n# get payloadTypes\ntarget_keys = filter(lambda i: i.startswith('PROTO_OA_'), dir(OAModel))\nout = dict(map(lambda k: [k, getattr(OAModel, k)], target_keys))\nout['PROTO_PROTO_MESSAGE' = 5;\nout['PROTO_ERROR_RES' = 50;\nout['PROTO_HEARTBEAT_EVENT' = 51;\nwith open('payloadTypes.json', 'w', encoding='utf-8') as f:\n  json.dump(out, f, ensure_ascii=False, indent=2)\n\n# get OAModel stuff\ntarget_keys = filter(lambda i: i.startswith('ProtoOA'), dir(OAModel))\nones_with_keyval = filter(lambda k: hasattr(getattr(OAModel,k),'keys'), target_keys)\nout = {}\nfor key in ones_with_keyval:\n  prop = getattr(OAModel, key)\n  out[key] = dict(zip(prop.keys(), prop.values()))\nwith open('OAModel.json', 'w', encoding='utf-8') as f:\n  json.dump(out, f, ensure_ascii=False, indent=2)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Keep in mind, in this approach, the naming of the messages change from\n",(0,i.jsx)(n.code,{children:"PascalCase"})," to ",(0,i.jsx)(n.code,{children:"UPPER_SNAKE_CASE"})," (aka ",(0,i.jsx)(n.code,{children:"SCREAMING_SNAKE_CASE"}),"), unless you\nmodify the code otherwise."]}),"\n",(0,i.jsx)(n.h3,{id:"correct-name-of-pypi-package",children:"Correct Name of PyPi Package"}),"\n",(0,i.jsxs)(n.p,{children:["The name of the package is actually ",(0,i.jsx)(n.code,{children:"ctrader_open_api"})," (separated by underline),\nbut even if you use the name ",(0,i.jsx)(n.code,{children:"ctrader-open-api"})," (separated by dash) to install\nit, it would still work. The reason for this is because the dash characters get\nautomatically converted to underlines in the process. Since this could be a\nsource of confusion, it's worth covering it here."]}),"\n",(0,i.jsxs)(n.p,{children:["Let's create an isolated environment and get a report of what packages would be\ninstalled after running a ",(0,i.jsx)(n.code,{children:"pip install"})," command (",(0,i.jsx)(n.code,{children:"--report"})," option), but without\nactually installing anything (",(0,i.jsx)(n.code,{children:"--dry-run"})," option), and then compare the two\nreports. So we install both a package named ",(0,i.jsx)(n.code,{children:"ctrader_open_api"}),", and another\nnamed ",(0,i.jsx)(n.code,{children:"ctrader-open-api"}),", and will store the report into files."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"mkdir test && cd test\npython -m venv .env\n.env\\Scripts\\activate\npip install ctrader_open_api --dry-run -I --report f1.json\npip install ctrader-open-api --dry-run -I --report f2.json\n"})}),"\n",(0,i.jsx)(n.p,{children:"And the we examine the two report files like below:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-py",children:"import json\n\ndef print_installed_pkgs(report_file)\n  o = json.load(open(report_file, encoding='utf-8-sig'))\n  a = [i['metadata']['name'] +'=='+ i['metadata']['version']\n    for i in o['install']]\n  print('\\n'.join(a))\n\nprint('installed pkgs after `pip install ctrader_open_api`')\nprint_installed_pkgs_from_report_file('f1.json')\nprint('-------------------------')\nprint('installed pkgs after `pip install ctrader-open-api`')\nprint_installed_pkgs_from_report_file('f2.json')\n"})}),"\n",(0,i.jsx)(n.p,{children:"As you can see below, both will install the same exact things."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"installed pkgs after `pip install ctrader_open_api`\nctrader_open_api==0.9.2\ninputimeout==1.0.4\nprotobuf==3.20.1\n...\n-------------------------\ninstalled pkgs after `pip install ctrader-open-api`\nctrader_open_api==0.9.2\ninputimeout==1.0.4\nprotobuf==3.20.1\n...\n"})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},5537:(e,n,t)=>{t.d(n,{A:()=>v});var o=t(6540),i=t(4164),a=t(5627),s=t(6347),r=t(372),l=t(604),p=t(1861),c=t(8749);function d(e){return o.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,o.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function h(e){const{values:n,children:t}=e;return(0,o.useMemo)(()=>{const e=n??function(e){return d(e).map(({props:{value:e,label:n,attributes:t,default:o}})=>({value:e,label:n,attributes:t,default:o}))}(t);return function(e){const n=(0,p.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,t])}function u({value:e,tabValues:n}){return n.some(n=>n.value===e)}function m({queryString:e=!1,groupId:n}){const t=(0,s.W6)(),i=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,l.aZ)(i),(0,o.useCallback)(e=>{if(!i)return;const n=new URLSearchParams(t.location.search);n.set(i,e),t.replace({...t.location,search:n.toString()})},[i,t])]}function f(e){const{defaultValue:n,queryString:t=!1,groupId:i}=e,a=h(e),[s,l]=(0,o.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!u({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const t=n.find(e=>e.default)??n[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:n,tabValues:a})),[p,d]=m({queryString:t,groupId:i}),[f,g]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[t,i]=(0,c.Dv)(n);return[t,(0,o.useCallback)(e=>{n&&i.set(e)},[n,i])]}({groupId:i}),j=(()=>{const e=p??f;return u({value:e,tabValues:a})?e:null})();(0,r.A)(()=>{j&&l(j)},[j]);return{selectedValue:s,selectValue:(0,o.useCallback)(e=>{if(!u({value:e,tabValues:a}))throw new Error(`Can't select invalid tab value=${e}`);l(e),d(e),g(e)},[d,g,a]),tabValues:a}}var g=t(9136);const j={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var x=t(4848);function b({className:e,block:n,selectedValue:t,selectValue:o,tabValues:s}){const r=[],{blockElementScrollPositionUntilNextRender:l}=(0,a.a_)(),p=e=>{const n=e.currentTarget,i=r.indexOf(n),a=s[i].value;a!==t&&(l(n),o(a))},c=e=>{let n=null;switch(e.key){case"Enter":p(e);break;case"ArrowRight":{const t=r.indexOf(e.currentTarget)+1;n=r[t]??r[0];break}case"ArrowLeft":{const t=r.indexOf(e.currentTarget)-1;n=r[t]??r[r.length-1];break}}n?.focus()};return(0,x.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.A)("tabs",{"tabs--block":n},e),children:s.map(({value:e,label:n,attributes:o})=>(0,x.jsx)("li",{role:"tab",tabIndex:t===e?0:-1,"aria-selected":t===e,ref:e=>{r.push(e)},onKeyDown:c,onClick:p,...o,className:(0,i.A)("tabs__item",j.tabItem,o?.className,{"tabs__item--active":t===e}),children:n??e},e))})}function y({lazy:e,children:n,selectedValue:t}){const a=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=a.find(e=>e.props.value===t);return e?(0,o.cloneElement)(e,{className:(0,i.A)("margin-top--md",e.props.className)}):null}return(0,x.jsx)("div",{className:"margin-top--md",children:a.map((e,n)=>(0,o.cloneElement)(e,{key:n,hidden:e.props.value!==t}))})}function w(e){const n=f(e);return(0,x.jsxs)("div",{className:(0,i.A)("tabs-container",j.tabList),children:[(0,x.jsx)(b,{...n,...e}),(0,x.jsx)(y,{...n,...e})]})}function v(e){const n=(0,g.A)();return(0,x.jsx)(w,{...e,children:d(e.children)},String(n))}},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>r});var o=t(6540);const i={},a=o.createContext(i);function s(e){const n=o.useContext(a);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),o.createElement(a.Provider,{value:n},e.children)}},9329:(e,n,t)=>{t.d(n,{A:()=>s});t(6540);var o=t(4164);const i={tabItem:"tabItem_Ymn6"};var a=t(4848);function s({children:e,hidden:n,className:t}){return(0,a.jsx)("div",{role:"tabpanel",className:(0,o.A)(i.tabItem,t),hidden:n,children:e})}}}]);